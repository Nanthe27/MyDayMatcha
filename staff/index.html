<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MyDayMatcha-Loyalty</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Nanthe27/MyDayMatcha/fac565acc942ff0260de380d21014a133789b493/Logo.png">
    <link rel="apple-touch-icon" href="https://github.com/Nanthe27/MyDayMatcha/blob/main/logo%20black%20and%20gole.jpg?raw=true">

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { 
            --bg: #ffffff; --text: #000; --sub: #666; --matcha: #017a3f; 
            --red: #d32f2f; --blue: #007aff; --border: #f2f2f2; --surf: #fafafa; 
            --radius-btn: 22px; --radius-card: 32px; 
            --ease: cubic-bezier(0.4, 0, 0.2, 1); 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; justify-content: center; overflow: hidden; user-select: none; }
        
        .app { width: 100%; height: 100%; max-width: 480px; display: flex; flex-direction: column; position: relative; padding: 0; }
        
        /* ADJUST SPACING HERE */
        @media screen and (max-width: 480px) {
            .app { 
                padding-top: 49px;    /* Space from mobile top screen edge */
                padding-bottom: 5px; /* Space from mobile bottom screen edge */
            }
        }

        header { height: 90px; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 20; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); }
        
        .pill-toggle { background: #eeeeee; padding: 6px; border-radius: 28px; display: flex; gap: 10px; }
        .pill-btn { padding: 10px 20px; border-radius: 22px; border: none; font-size: 13px; font-weight: 700; color: #666; background: transparent; transition: all 0.3s var(--ease); cursor: pointer; }
        .pill-btn.active { background: #fff; color: var(--matcha); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .pill-btn:active { transform: scale(0.95); }

        .btn-red-back { background: var(--red); color: #fff; padding: 12px 20px; border-radius: 20px; font-size: 13px; font-weight: 700; border: none; transition: all 0.2s; }
        .btn-red-back:active { transform: scale(0.95); opacity: 0.9; }

        .search-row { display: flex; gap: 20px; margin-bottom: 24px; position: relative; }

        .view-container { position: relative; flex: 1; overflow: hidden; }
        .view { position: absolute; top: 0; width: 100%; height: 100%; padding: 24px; opacity: 0; transform: translateY(10px); pointer-events: none; transition: all 0.4s var(--ease); display: flex; flex-direction: column; background: #fff; }
        .view.active { opacity: 1; transform: translateY(0); pointer-events: auto; z-index: 10; }

        input { width: 100%; padding: 18px; border: 1px solid var(--border); border-radius: var(--radius-btn); font-size: 16px; background: var(--surf); outline: none; transition: all 0.3s var(--ease); font-family: inherit; margin-bottom: 32px; }
        input:focus { border-color: var(--matcha); background: #fff; box-shadow: 0 0 0 4px rgba(1, 122, 63, 0.05); }

        .btn { width: 100%; padding: 20px; border-radius: var(--radius-btn); font-size: 16px; font-weight: 700; cursor: pointer; border: none; transition: all 0.2s var(--ease); display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 32px; letter-spacing: -0.02em; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-green { background: var(--matcha); color: #fff; }
        .btn-blue { background: var(--blue); color: #fff; }
        .btn-red { background: var(--red); color: #fff; }
        .btn-ghost { background: transparent; color: var(--sub); width: auto; padding: 12px 18px; margin-bottom: 24px; font-size: 14px; }

        .card { background: var(--surf); padding: 40px 24px; border-radius: var(--radius-card); text-align: center; border: 1px solid var(--border); margin-bottom: 40px; }
        
        .qty-box { display: flex; align-items: center; justify-content: center; gap: 48px; margin-bottom: 48px; }
        .btn-circ { width: 68px; height: 68px; border-radius: 50%; font-size: 28px; border: none; color: #fff; display: flex; align-items: center; justify-content: center; }

        .live-results { position: absolute; top: 75px; left: 0; right: 0; background: #fff; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); border: 1px solid var(--border); list-style: none; padding: 8px; z-index: 100; display: none; overflow: hidden; }
        .live-results.show { display: block; animation: slideUp 0.3s var(--ease); }
        .live-item { padding: 18px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .live-item:active { background: var(--surf); transform: scale(0.98); }

        .dots { display: flex; justify-content: center; gap: 16px; margin-top: 28px; }
        .dot { width: 14px; height: 14px; border-radius: 50%; background: #e0e0e0; transition: all 0.4s var(--ease); }
        .dot.fill { background: var(--matcha); transform: scale(1.25); }

        #reader { border-radius: 48px; overflow: hidden; margin-bottom: 40px; display: none; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; aspect-ratio: 1/1; position: relative; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; border-radius: 48px; }

        #card-modal { position: fixed; inset:0; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); z-index: 300; display: none; justify-content: center; align-items: center; padding: 24px; opacity: 0; transition: all 0.4s var(--ease); }
        #card-modal.show { opacity: 1; display: flex; }
        .modal-content { background: white; padding: 40px; border-radius: 40px; width: 100%; max-width: 420px; text-align: center; transform: scale(0.9) translateY(20px); transition: all 0.5s var(--ease); }
        #card-modal.show .modal-content { transform: scale(1) translateY(0); }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 500; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .spinner { width: 44px; height: 44px; border: 4px solid #f0f0f0; border-top-color: var(--matcha); border-radius: 50%; animation: s 0.9s infinite cubic-bezier(0.5, 0.1, 0.4, 0.9); }
        
        @keyframes s { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app">
    <header>
        <button class="btn-red-back" onclick="window.location.href='https://nanthe27.github.io/MyDayMatcha/'">Back To Menu</button>
        <div class="pill-toggle">
            <button id="pill-scan" class="pill-btn active" onclick="goHome()">Scan</button>
            <button id="pill-manage" class="pill-btn" onclick="switchView('v-manage')">Manage</button>
        </div>
    </header>

    <div class="view-container">
        <div id="v-scan" class="view active">
            <div class="search-row">
                <input type="text" id="scanSearchInput" placeholder="Points: Search ID/Name" onkeyup="doLiveScan(this.value)" style="margin:0">
                <button class="btn btn-green" style="width:80px; padding:0; margin:0;" onclick="doManualScan()">Go</button>
                <ul id="scanLiveResults" class="live-results"></ul>
            </div>
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div id="reader"></div>
                <button id="b-scan" class="btn btn-green" onclick="startScan()">Scan QR Code</button>
            </div>
        </div>

        <div id="v-cust" class="view">
            <button class="btn btn-ghost" onclick="goHome()">‚Üê Back to Scan</button>
            <div class="card">
                <h2 id="d-name" style="font-family:'Quicksand'; font-size: 32px; margin-bottom: 12px;">...</h2>
                <div id="d-id" style="color:var(--sub); font-family:monospace; margin-bottom:32px; font-size: 16px;">...</div>
                <button class="btn btn-green" style="margin: 0 auto 12px; padding: 16px 28px; width: auto;" onclick="generateCard()">Generate QR Card</button>
                <div class="dots" id="d-dots"></div>
            </div>
            <div id="r-msg" style="background:var(--matcha); color:#fff; padding:24px; border-radius:24px; text-align:center; font-weight:700; display:none; margin-bottom:40px;">üéâ REWARD READY</div>
            <div style="margin-top:auto">
                <button id="b-red" class="btn btn-blue" style="display:none;" onclick="doAction('redeemReward')">Redeem Reward</button>
                <div id="q-ctrl" class="qty-box">
                    <button class="btn-circ btn-red" onclick="adj(-1)">‚àí</button>
                    <span id="q-val" style="font-size:36px; font-weight:700;">1</span>
                    <button class="btn-circ btn-green" onclick="adj(1)">+</button>
                </div>
                <button id="b-add" class="btn btn-green" onclick="doAction('addPurchase')">Confirm Purchase</button>
            </div>
        </div>

        <div id="v-manage" class="view">
            <button class="btn btn-ghost" onclick="goHome()">‚Üê Back to Scan</button>
            <div class="search-row">
                <input type="text" id="manageSearchInput" placeholder="Filter customer list..." onkeyup="renderList(this.value)" style="margin:0">
                <button class="btn btn-green" style="width:60px; padding:0; margin:0; font-size: 24px;" onclick="showForm()">+</button>
            </div>
            <ul id="m-list" style="list-style:none; padding:0; margin:0; overflow-y:auto; flex: 1;"></ul>
        </div>

        <div id="v-form" class="view">
            <button class="btn btn-ghost" onclick="switchView('v-manage')">‚Üê Back to Manage</button>
            <h2 id="f-title" style="font-family:'Quicksand'; font-size: 28px; margin-bottom: 32px;">New Customer</h2>
            <label style="font-size:12px; font-weight: 700; text-transform: uppercase; color:var(--sub); margin: 0 0 12px 8px; display: block;">Customer ID / Phone</label>
            <input type="text" id="f-phone">
            <label style="font-size:12px; font-weight: 700; text-transform: uppercase; color:var(--sub); margin: 0 0 12px 8px; display: block;">Full Name</label>
            <input type="text" id="f-name">
            <button class="btn btn-green" style="margin-bottom: 32px; background:var(--surf); color:var(--text); border:1px solid var(--border);" onclick="generateFromForm()">Preview QR Card</button>
            <div style="margin-top:auto">
                <button class="btn btn-green" onclick="save()">Save Customer</button>
                <button id="f-del" class="btn btn-red" style="background:transparent; color:var(--red); border:1px solid var(--red);" onclick="del()">Delete Customer</button>
            </div>
        </div>
    </div>
</div>

<div id="card-modal" onclick="closeCard()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div id="card-canvas-container"></div>
        <p style="font-size:13px; color:var(--sub); margin: 32px 0 16px; font-weight: 600;">Tap button below to Save High-Res</p>
        <button id="downloadBtn" class="btn btn-green" style="margin-bottom: 16px;">Download Card</button>
        <button class="btn btn-ghost" onclick="closeCard()" style="margin:0">Close</button>
    </div>
    <div id="qr-hidden" style="display:none;"></div>
</div>

<div id="loader"><div class="spinner"></div></div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwG-iVOOnP5869o5jOZBrxnaMYJv3jIx-iVdhF0NlVlRTAFeyO9S01uSDbeIZDwhSD-Ug/exec";
    const KEY = "ch#@ngch@mn@n2712@mydaymatcha";
    const LOGO_URL = "https://raw.githubusercontent.com/Nanthe27/MyDayMatcha/fac565acc942ff0260de380d21014a133789b493/Logo.png";
    let db = [], cur = null, sc = null, qty = 1;

    const get = (id) => document.getElementById(id);
    const load = (s) => get('loader').style.display = s ? 'flex' : 'none';

    window.onload = async () => {
        load(1);
        try {
            const r = await fetch(API, {method:"POST", body:JSON.stringify({action:"sync", api_key:KEY})});
            const j = await r.json();
            if(j.success) { db = j.local_db; renderList(); }
        } catch(e) {}
        load(0);
    };

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        get(id).classList.add('active');
        document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
        if(id === 'v-manage') get('pill-manage').classList.add('active');
        else if(id === 'v-scan') get('pill-scan').classList.add('active');
        if(id === 'v-scan') stopScan();
    }

    function goHome() { 
        get('scanSearchInput').value = ""; 
        get('scanLiveResults').classList.remove('show'); 
        switchView('v-scan'); 
    }

    function doLiveScan(q) {
        const l = get('scanLiveResults');
        q = q.trim().toLowerCase();
        if(q.length < 2) { l.classList.remove('show'); return; }
        const m = db.filter(c => String(c.customer_id).includes(q) || c.name.toLowerCase().includes(q)).slice(0, 5);
        if(m.length) {
            l.innerHTML = m.map(c => `<li class="live-item" onclick="selScan('${c.customer_id}')"><div><b>${c.name}</b><br><small style="opacity:0.6">${c.customer_id}</small></div><b style="color:var(--matcha)">${c.purchase_count} pts</b></li>`).join('');
            l.classList.add('show');
        } else l.classList.remove('show');
    }

    function selScan(id) { 
        get('scanLiveResults').classList.remove('show'); 
        get('scanSearchInput').value = ""; 
        loadCust(db.find(c => c.customer_id == id)); 
    }

    function doManualScan() {
        const v = get('scanSearchInput').value.trim();
        const f = db.find(c => c.customer_id == v || c.name.toLowerCase() == v.toLowerCase());
        if(f) loadCust(f); else if(confirm("Not found. Create new?")) showForm(v);
    }

    function loadCust(c) {
        cur = c; qty = 1; get('q-val').innerText = 1;
        get('d-name').innerText = c.name; get('d-id').innerText = c.customer_id;
        const pts = c.purchase_count % 5;
        get('d-dots').innerHTML = [0,1,2,3,4].map(i => `<div class="dot ${i<pts?'fill':''}"></div>`).join('');
        const rdy = c.purchase_count >= 5;
        get('r-msg').style.display = rdy ? 'block' : 'none';
        get('b-red').style.display = rdy ? 'block' : 'none';
        get('b-add').style.display = rdy ? 'none' : 'block';
        get('q-ctrl').style.display = rdy ? 'none' : 'flex';
        switchView('v-cust');
    }

    function generateAutoId() {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const datePart = `${pad(now.getDate())}${pad(now.getMonth()+1)}${String(now.getFullYear()).slice(-2)}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        return `${datePart}-${Math.floor(1000 + Math.random() * 9000)}`;
    }

    function showForm(p="") { 
        get('f-title').innerText="New Customer"; 
        get('f-phone').value = p || generateAutoId();
        get('f-phone').disabled=false; 
        get('f-name').value=""; 
        get('f-del').style.display="none"; 
        switchView('v-form'); 
    }
    
    function edit(id) { 
        const c = db.find(x => x.customer_id == id);
        get('f-title').innerText="Edit Customer"; 
        get('f-phone').value=c.customer_id; 
        get('f-phone').disabled=true; 
        get('f-name').value=c.name; 
        get('f-del').style.display="block"; 
        switchView('v-form'); 
    }

    function generateFromForm() {
        const n = get('f-name').value, p = get('f-phone').value;
        if(!n || !p) return alert("Please enter Name and ID first.");
        generateCard(n, p);
    }

    function generateCard(name, id) {
        if(!name && cur) { name = cur.name; id = cur.customer_id; }
        load(1);
        const qrData = JSON.stringify({ app: "matcha", id: id });
        get('qr-hidden').innerHTML = "";
        new QRCode(get('qr-hidden'), { text: qrData, width: 1024, height: 1024, correctLevel: QRCode.CorrectLevel.H });
        const logoImg = new Image();
        logoImg.crossOrigin = "Anonymous";
        logoImg.src = LOGO_URL;
        logoImg.onload = () => drawCanvas(name, id, logoImg);
        logoImg.onerror = () => drawCanvas(name, id, null);
    }

    function drawCanvas(name, id, logoImg) {
        const S = 4;
        const canvas = document.createElement('canvas');
        canvas.width = 600 * S; canvas.height = 850 * S;
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
        ctx.fillStyle = "#017a3f"; ctx.fillRect(0,0,600*S, 850*S);
        ctx.fillStyle = "#ffffff"; drawRoundedRect(ctx, 40*S, 40*S, 520*S, 770*S, 50*S); ctx.fill();

        if(logoImg) {
            const size = 160 * S; const cx = 300 * S; const cy = 150 * S; const r = size / 2;
            ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.clip();
            const aspect = logoImg.width / logoImg.height;
            let drawW, drawH;
            if (aspect > 1) { drawH = size; drawW = size * aspect; } else { drawW = size; drawH = size / aspect; }
            ctx.drawImage(logoImg, cx - drawW/2, cy - drawH/2, drawW, drawH);
            ctx.restore();
            ctx.strokeStyle = "#017a3f"; ctx.lineWidth = 5 * S; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.stroke();
        }

        const qrImg = get('qr-hidden').querySelector('img');
        if(qrImg) ctx.drawImage(qrImg, 150 * S, 260 * S, 300 * S, 300 * S);
        ctx.textAlign = "center";
        ctx.fillStyle = "#000000"; ctx.font = `bold ${52*S}px Quicksand`; ctx.fillText(name, 300 * S, 630 * S);
        ctx.fillStyle = "#888888"; ctx.font = `${34*S}px monospace`; ctx.fillText("ID: " + id, 300 * S, 690 * S);
        ctx.fillStyle = "#017a3f"; ctx.font = `bold ${30*S}px Quicksand`; ctx.fillText("SCAN TO EARN POINTS", 300 * S, 770 * S);

        const imgData = canvas.toDataURL("image/png", 1.0);
        const finalImg = document.createElement('img');
        finalImg.src = imgData; finalImg.style.width = "100%"; finalImg.style.borderRadius = "24px";
        get('card-canvas-container').innerHTML = "";
        get('card-canvas-container').appendChild(finalImg);
        
        const safeName = name.replace(/\s+/g, '_');
        const filename = `${safeName}_${id}_MyDayMatcha.png`;
        get('downloadBtn').onclick = () => {
            const link = document.createElement('a');
            link.download = filename; link.href = imgData; link.click();
        };
        load(0); get('card-modal').classList.add('show');
    }

    function drawRoundedRect(ctx, x, y, w, h, r) {
        ctx.beginPath(); ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r); ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h); ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r); ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y); ctx.closePath();
    }

    function closeCard() { get('card-modal').classList.remove('show'); }
    function adj(n) { qty = Math.max(1, qty + n); get('q-val').innerText = qty; }

    async function doAction(a) {
        load(1);
        const r = await fetch(API, {method:"POST", body:JSON.stringify({action:a, customer_id:cur.customer_id, qty:qty, api_key:KEY})});
        const j = await r.json();
        if(j.success) {
            cur.purchase_count = j.purchase_count;
            const i = db.findIndex(x => x.customer_id == cur.customer_id);
            if(i>-1) db[i].purchase_count = j.purchase_count;
            loadCust(cur); renderList();
        }
        load(0);
    }

    function renderList(q = "") {
        q = q.toLowerCase();
        get('m-list').innerHTML = db.filter(c => String(c.customer_id).includes(q) || c.name.toLowerCase().includes(q))
            .map(c => `<li class="live-item" onclick="edit('${c.customer_id}')"><div><b style="font-size:17px">${c.name}</b><br><small style="opacity:0.6">${c.customer_id}</small></div><b style="color:var(--matcha)">${c.purchase_count} pts</b></li>`).join('');
    }

    async function save() {
        const p = get('f-phone').value, n = get('f-name').value;
        if(!p || !n) return;
        load(1);
        const a = get('f-title').innerText == "New Customer" ? "createCustomer" : "editCustomer";
        const r = await fetch(API, {method:"POST", body:JSON.stringify({action:a, customer_id:p, name:n, phone:p, api_key:KEY})});
        const j = await r.json();
        if(j.success) {
            if(a=="createCustomer") db.push({customer_id:p, name:n, purchase_count:0});
            else db.find(x => x.customer_id == p).name = n;
            renderList(); switchView('v-manage');
        } else alert(j.message);
        load(0);
    }

    async function del() {
        const confirmation = prompt("To permanently delete this customer, type 'DELETEUSER' below:");
        if (confirmation !== "DELETEUSER") { alert("Deletion cancelled."); return; }
        const p = get('f-phone').value;
        load(1);
        const r = await fetch(API, {method:"POST", body:JSON.stringify({action:"deleteCustomer", customer_id:p, api_key:KEY})});
        const j = await r.json();
        if(j.success) { db = db.filter(x => x.customer_id != p); renderList(); switchView('v-manage'); }
        load(0);
    }

    function startScan() {
        get('b-scan').style.display='none'; get('reader').style.display='block';
        sc = new Html5Qrcode("reader");
        sc.start({facingMode:"environment"}, {fps:10, qrbox:250}, (t) => { 
            stopScan();
            try {
                const data = JSON.parse(t);
                if (data.app === "matcha") {
                    const f = db.find(c => c.customer_id == data.id);
                    if(f) loadCust(f); else if(confirm("New Card. Create profile?")) showForm(data.id);
                } else alert("Invalid Card Format");
            } catch(e) {
                if(!isNaN(t)) { get('scanSearchInput').value = t; doManualScan(); } else alert("QR Code not recognized.");
            }
        });
    }
    function stopScan() { if(sc) sc.stop(); get('reader').style.display='none'; get('b-scan').style.display='block'; }
</script>
</body>
</html>
