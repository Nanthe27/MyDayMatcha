<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Day Matcha POS</title>
    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #eef1f5; 
            margin: 0; padding: 0; 
            height: 100vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        
        /* HEADER */
        .top-bar {
            background: #2e7d32; 
            color: white; 
            padding: 0 15px; 
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .top-bar h1 { margin: 0; font-size: 18px; font-weight: 700; }
        
        .device-badge {
            background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-right: 10px;
        }

        .export-btn {
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;
            transition: all 0.2s;
        }
        .export-btn:hover { background: rgba(255,255,255,0.3); }

        /* DASHBOARD LAYOUT */
        .dashboard {
            display: flex;
            flex: 1;
            height: calc(100vh - 50px);
            gap: 2px;
        }

        /* COLUMNS */
        .col {
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow-y: hidden;
        }

        .col-menu { flex: 0.8; background: #fff; padding: 10px; overflow-y: auto; }
        .col-preview { 
            flex: 1.4; background: #fff; display: flex; flex-direction: column; 
            box-shadow: -2px 0 5px rgba(0,0,0,0.05); z-index: 5; 
        }
        .col-history { flex: 1; background: #f4f5f7; padding: 10px; overflow-y: auto; }

        .col-header {
            font-size: 14px; font-weight: 700; color: #555; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 10px; padding-bottom: 8px;
            border-bottom: 2px solid #eee; flex-shrink: 0;
        }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* --- ANIMATED BUTTONS --- */
        .drink-btn { 
            color: white; 
            border: none; 
            padding: 8px 4px; 
            border-radius: 10px; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 70px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            line-height: 1.2;
            position: relative;
            overflow: hidden; 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .drink-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            filter: brightness(1.1);
        }

        .drink-btn:active {
            transform: scale(0.95) translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: 0.05s; 
        }

        .drink-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -120%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .drink-btn:hover::after { left: 120%; }
        
        /* Button Colors */
        .matcha-latte { background: #4CAF50; }
        .matcha-strawberry { background: #E91E63; }
        .matcha-coconut-cream { background: #00BCD4; }
        .coconut-matcha { background: #FFC107; color: #333 !important; }
        .coffee-condensed { background: #795548; }
        .black-coffee { background: #212121; }

        /* PREVIEW SECTION */
        .cart-list { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #eee;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(-10px); } 
            to { opacity: 1; transform: translateX(0); } 
        }

        .cart-details { 
            display: flex; 
            flex-direction: row; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 6px; 
            width: 80%; 
        }
        .cart-name { font-weight: 600; font-size: 14px; color: #333; margin-right: 2px; }
        .dropdown-select { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; background: #fff;}
        
        .cart-action { display: flex; align-items: center; gap: 8px; }
        .delete-btn { 
            background: #ffebee; color: #c62828; border: none; width: 28px; height: 28px; border-radius: 4px; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }
        .delete-btn:hover { background: #ffcdd2; transform: scale(1.1); }

        .cart-footer { background: #f9f9f9; border-top: 1px solid #ddd; padding: 15px; }
        .total-display { font-size: 24px; font-weight: 800; color: #2e7d32; text-align: right; margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; }
        .btn { 
            flex: 1; padding: 12px; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 15px; font-weight: bold; 
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #b0bec5; color: white; }

        /* HISTORY SECTION */
        .record-item { background: white; padding: 10px; margin-bottom: 6px; border-radius: 6px; border: 1px solid #eee; }
        .record-top { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 2px; }
        .record-body { font-size: 13px; color: #333; margin-bottom: 2px; line-height: 1.3; }
        .record-price { font-weight: bold; color: #2e7d32; font-size: 13px; display: flex; justify-content: space-between; align-items: center;}
        .del-btn { color: #d32f2f; background: none; border: none; cursor: pointer; font-weight: bold; font-size: 16px;}
        .del-btn:hover { transform: scale(1.2); }
        .daily-total { text-align: center; font-weight: bold; margin-top: 10px; font-size: 14px; color: #333;}

        /* MOBILE */
        @media (max-width: 900px) {
            body { overflow: auto; height: auto; }
            .dashboard { flex-direction: column; height: auto; gap: 10px; }
            .col { border-right: none; border-bottom: 1px solid #ddd; overflow-y: visible; }
            .col-menu { flex: none; }
            .col-preview { flex: none; order: 2; border-top: 4px solid #eee; }
            .col-history { flex: none; order: 3; max-height: 400px; overflow-y: auto;}
            .cart-footer { position: sticky; bottom: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center;">
            <h1>My Day Matcha</h1>
            <span id="deviceDisplay" class="device-badge" style="margin-left:15px; color:#cfd8dc; font-weight:normal;"></span>
        </div>
        <button class="export-btn" onclick="exportToExcel()">ðŸ“Š Export CSV</button>
    </div>

    <div class="dashboard">
        <div class="col col-menu">
            <div class="col-header">Select Drink</div>
            <div class="menu-grid">
                <button class="drink-btn matcha-latte" onclick="addDrink('Matcha Latte', 5500, true)">Matcha Latte</button>
                <button class="drink-btn matcha-strawberry" onclick="addDrink('Matcha Strawberry', 7000, true)">Matcha Strawberry</button>
                <button class="drink-btn matcha-coconut-cream" onclick="addDrink('Matcha Coconut Cream', 7000, false)">Matcha Coconut Cream</button>
                <button class="drink-btn coconut-matcha" onclick="addDrink('Coconut Matcha', 6000, false)">Coconut Matcha</button>
                <button class="drink-btn coffee-condensed" onclick="addDrink('Coffee Condensed Milk', 4000, false)">Coffee Condensed Milk</button>
                <button class="drink-btn black-coffee" onclick="addDrink('Black Coffee', 3000, false)">Black Coffee</button>
            </div>
        </div>

        <div class="col col-preview">
            <div class="col-header" style="padding: 15px 15px 0 15px; margin-bottom: 5px; border:none;">Current Order</div>
            <div class="cart-list" id="orderList">
                <div style="text-align:center; color:#ccc; margin-top:20px;">Empty Cart</div>
            </div>
            <div class="cart-footer">
                <div class="total-display" id="total">0 KHR</div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="completeOrder()">CHARGE</button>
                    <button class="btn btn-secondary" onclick="clearOrder()">Clear</button>
                </div>
            </div>
        </div>

        <div class="col col-history">
            <div class="col-header">History <button style="float:right; border:none; background:none; color:red; cursor:pointer;" onclick="clearRecords()">Reset</button></div>
            <div id="recordList">
                <div style="text-align:center; color:#999; font-size:12px;">No sales yet.</div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION: YOUR DATA CONNECTION
        // ==========================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2sAhVj0OvaUW_90iDg4D0e7xgnJagQVIumqeYljT9h2IgA6GsJoHTo6d_ENsieEbW/exec'; 
        
        // --- REAL COST CONFIGURATION ---
        const drinkCosts = {
            'Matcha Latte': 4500,
            'Matcha Strawberry': 5000,
            'Matcha Coconut Cream': 5000,
            'Coconut Matcha': 4500,
            'Coffee Condensed Milk': 3000,
            'Black Coffee': 2000
        };

        let currentOrder = [];
        let orderIndex = 0;
        let todayRecords = JSON.parse(localStorage.getItem('cafeRecords_' + new Date().toDateString())) || [];
        const sweetnessLevels = ['100%', '75%', '50%', '30%', '10%', '0%'];
        const milkOptions = ['Milk', 'Oat Milk'];
        
        // --- DEVICE / USER IDENTITY ---
        let deviceName = localStorage.getItem('matcha_device_name');
        if (!deviceName) {
            deviceName = prompt("Enter Device Name (e.g. 'Phone', 'Laptop', 'Staff 1'):") || "Unknown Device";
            localStorage.setItem('matcha_device_name', deviceName);
        }
        document.getElementById('deviceDisplay').innerText = deviceName;

        function addDrink(name, price, hasMilk) {
            const myCost = drinkCosts[name] || 0;
            currentOrder.push({
                id: orderIndex++, 
                name: name, 
                price: price, 
                cost: myCost, 
                sweetness: '100%', 
                milk: hasMilk ? 'Milk' : null
            });
            updateOrderDisplay();
        }

        function updateOrderDisplay() {
            const list = document.getElementById('orderList');
            const total = document.getElementById('total');
            let html = '';
            let subtotal = 0;
            
            currentOrder.forEach(item => {
                html += `
                    <div class="cart-item">
                        <div class="cart-details">
                            <span class="cart-name">${item.name}</span>
                            ${item.milk ? `<select class="dropdown-select" onchange="updateMilk(${item.id}, this.value)">${milkOptions.map(opt => `<option value="${opt}" ${opt === item.milk ? 'selected' : ''}>${opt}</option>`).join('')}</select>` : ''}
                            <select class="dropdown-select" onchange="updateSweetness(${item.id}, this.value)">
                                ${sweetnessLevels.map(lvl => `<option value="${lvl}" ${lvl === item.sweetness ? 'selected' : ''}>${lvl}</option>`).join('')}
                            </select>
                        </div>
                        <div class="cart-action">
                            <span style="font-weight:bold; font-size:13px;">${item.price.toLocaleString()}</span>
                            <button class="delete-btn" onclick="removeItem(${item.id})">Ã—</button>
                        </div>
                    </div>`;
                subtotal += item.price;
            });
            
            list.innerHTML = html || '<div style="text-align:center; color:#ccc; margin-top:20px;">Empty Cart</div>';
            total.textContent = `${subtotal.toLocaleString()} KHR`;
            list.scrollTop = list.scrollHeight;
        }

        function updateSweetness(id, val) {
            const item = currentOrder.find(i => i.id === id);
            if (item) item.sweetness = val;
        }

        function updateMilk(id, val) {
            const item = currentOrder.find(i => i.id === id);
            if (item) item.milk = val;
        }

        function removeItem(id) {
            const idx = currentOrder.findIndex(i => i.id === id);
            if(idx > -1) currentOrder.splice(idx, 1);
            updateOrderDisplay();
        }

        function completeOrder() {
            if (currentOrder.length === 0) return;
            const subtotal = currentOrder.reduce((s, i) => s + i.price, 0);
            const now = new Date();
            
            // 1. Group for history & Cloud
            const groupedOrder = {};
            const cloudItems = [];

            currentOrder.forEach(item => {
                let key = `${item.name} (${item.sweetness})`;
                if (item.milk && item.name !== 'Coffee Condensed Milk') key += ` ${item.milk}`;
                
                if (!groupedOrder[key]) {
                    groupedOrder[key] = {
                        name: key, // Full name
                        qty: 0, 
                        unitPrice: item.price,
                        unitCost: item.cost
                    };
                }
                groupedOrder[key].qty++;
            });

            // Convert for Cloud Upload
            for (let k in groupedOrder) {
                let i = groupedOrder[k];
                cloudItems.push({
                    date: now.toDateString(),
                    time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    id: Date.now(),
                    name: i.name,
                    price: i.unitPrice,
                    cost: i.unitCost,
                    qty: i.qty,
                    profit: (i.unitPrice * i.qty) - (i.unitCost * i.qty)
                });
            }

            // 2. SEND TO GOOGLE SHEETS (Automatic Backup)
            // Using 'no-cors' mode which is required for Google Scripts to accept data without complex handshake
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: deviceName, items: cloudItems })
            }).then(() => console.log("Data synced to sheet"))
              .catch(err => console.error("Sync failed", err));
            
            // 3. Save to Local Storage (Instant feel)
            const record = {
                id: Date.now(),
                time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                drinks: groupedOrder, 
                total: subtotal
            };
            
            todayRecords.unshift(record);
            localStorage.setItem('cafeRecords_' + now.toDateString(), JSON.stringify(todayRecords));
            currentOrder = []; orderIndex = 0;
            updateOrderDisplay();
            updateRecordsDisplay();
        }

        function updateRecordsDisplay() {
            const list = document.getElementById('recordList');
            if (todayRecords.length === 0) { list.innerHTML = '<div style="text-align:center; color:#999; font-size:12px;">No sales yet.</div>'; return; }
            let html = ''; let dailyTotal = 0;
            
            todayRecords.forEach(r => {
                let dStr = ''; 
                for(let k in r.drinks) dStr += `${k} x${r.drinks[k].qty}, `;
                dStr = dStr.slice(0, -2);
                
                html += `<div class="record-item">
                    <div class="record-top">
                        <span>${r.time}</span>
                        <button class="del-btn" onclick="deleteRecord(${r.id})">Ã—</button>
                    </div>
                    <div class="record-body">${dStr}</div>
                    <div class="record-price">${r.total.toLocaleString()} KHR</div>
                </div>`;
                dailyTotal += r.total;
            });
            html += `<div class="daily-total">Today: ${dailyTotal.toLocaleString()} KHR</div>`;
            list.innerHTML = html;
        }

        function clearOrder() { currentOrder = []; updateOrderDisplay(); }
        function deleteRecord(id) {
            if(confirm('Delete?')) {
                todayRecords = todayRecords.filter(r => r.id !== id);
                localStorage.setItem('cafeRecords_' + new Date().toDateString(), JSON.stringify(todayRecords));
                updateRecordsDisplay();
            }
        }
        function clearRecords() {
            if(confirm('Reset all?')) {
                todayRecords = [];
                localStorage.removeItem('cafeRecords_' + new Date().toDateString());
                updateRecordsDisplay();
            }
        }

        function exportToExcel() {
            if (todayRecords.length === 0) { alert('No records!'); return; }
            let csv = "\uFEFF"; 
            csv += "Date,Time,Device,Order ID,Item Name,Unit Sell Price,Unit Real Cost,Quantity,Total Sell,Total Cost,Total Profit\n";
            todayRecords.forEach(r => {
                for (let drinkName in r.drinks) {
                    const item = r.drinks[drinkName];
                    const qty = item.qty;
                    const totalSell = item.unitPrice * qty;
                    const totalCost = item.unitCost * qty;
                    const cleanName = drinkName.replace(/"/g, '""');
                    csv += `"${new Date().toDateString()}",${r.time},"${deviceName}","${r.id}","${cleanName}",${item.unitPrice},${item.unitCost},${qty},${totalSell},${totalCost},${totalSell - totalCost}\n`;
                }
            });
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = `Sales_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        updateOrderDisplay();
        updateRecordsDisplay();
    </script>
</body>
</html>
