<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#FFFFFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111111" media="(prefers-color-scheme: dark)">
    
    <title>My Day Matcha</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/Nanthe27/MyDayMatcha/a10b4d4f580a0e014e57221c0b136abf501a8d1f/Logo.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Nanthe27/MyDayMatcha/a10b4d4f580a0e014e57221c0b136abf501a8d1f/Logo.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Quicksand:wght@700&family=Courier+Prime&display=swap" rel="stylesheet">

    <style>
        :root { 
            --primary: #4CAF50; 
            --primary-dim: #2E7D32;
            --primary-light: #A5D6A7;
            --bg: #F2F2F7; 
            --surface: #FFFFFF; 
            --surface-hover: #F5F5F5;
            --text: #000000; 
            --text-muted: #8E8E93; 
            --border: #E5E5EA; 
            --radius: 16px; 
            --anim-speed: 0.25s;
            --anim-curve: cubic-bezier(0.2, 0, 0, 1);
            
            /* LIQUID GLASS THEME VARIABLES (LIGHT) */
            --glass-bg: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        [data-theme="dark"] { 
            --bg: #050505; 
            --surface: #111111; 
            --surface-hover: #1A1A1A;
            --text: #FFFFFF; 
            --text-muted: #888888; 
            --border: #333333; 
            
            /* LIQUID GLASS THEME VARIABLES (DARK) */
            --glass-bg: rgba(25, 25, 25, 0.2);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 0; height: 100vh; width: 100vw; 
            display: flex; flex-direction: column; overflow: hidden; 
            padding-top: 0; 
            transition: background var(--anim-speed) var(--anim-curve), color var(--anim-speed) var(--anim-curve);
        }

        @keyframes fadeScale { 0% { opacity: 0; transform: scale(0.98); } 100% { opacity: 1; transform: scale(1); } }
        .main-stage, .modal-box, #loginScreen, .cart-area.active, .settings-area.active, #managerPage, #editorModal, #inventoryPage, #invEditorModal { animation: fadeScale var(--anim-speed) var(--anim-curve); }

        /* --- HEADER --- */
        .app-header { 
            height: calc(70px + env(safe-area-inset-top)); 
            padding: env(safe-area-inset-top) 20px 0 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--surface); border-bottom: 1px solid var(--border); 
            z-index: 50; flex-shrink: 0; 
        }
        
        .brand { font-family: 'Quicksand', sans-serif; font-size: 18px; font-weight: 700; color: var(--primary); letter-spacing: 0.5px; display: flex; align-items: center; gap: 10px; }
        .app-logo { height: 32px; width: 32px; border-radius: 50%; border: 1px solid var(--primary); }
        
        .hamburger-btn { 
            background: transparent; border: none; 
            color: var(--text); font-size: 26px; cursor: pointer; 
            width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center; 
            transition: transform 0.2s var(--anim-curve), color 0.2s; 
        }
        .hamburger-btn:hover { color: var(--primary); transform: scale(1.1); }
        .hamburger-btn.active { color: var(--primary); transform: rotate(90deg); }

        .main-stage { flex: 1; padding: 15px; display: flex; justify-content: center; overflow: hidden; position: relative; }
        
        .menu-area { 
            width: 100%; max-width: 1200px; 
            overflow-y: auto; display: grid; 
            grid-template-columns: 1fr 1fr; grid-auto-rows: 80px; 
            gap: 12px; align-content: start; 
            padding-bottom: 200px; 
        }
        
        .drink-btn { width: 100%; height: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); display: flex; align-items: center; padding: 10px; gap: 12px; overflow: hidden; cursor: pointer; position: relative; text-align: left; transition: all 0.2s var(--anim-curve); }
        .drink-btn:hover { border-color: var(--primary); background: var(--surface-hover); transform: scale(0.97); }
        .drink-btn:active { transform: scale(0.94); opacity: 0.9; }
        .drink-icon-box { width: 45px; height: 45px; min-width: 45px; background-color: var(--surface-hover); background-size: cover; background-position: center; border-radius: var(--radius); transition: background-image 0.3s ease-in; }
        .drink-info-box { flex: 1; display: flex; align-items: center; overflow: hidden; }
        .drink-name { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 13px; color: var(--text); line-height: 1.2; }

        .cart-area { 
            display: flex; flex-direction: column; background: var(--surface); border-radius: var(--radius); 
            position: fixed; 
            top: calc(70px + env(safe-area-inset-top)); 
            bottom: 80px; 
            left: 0; width: 100%; height: auto; 
            z-index: 150; opacity: 0; visibility: hidden; pointer-events: none; 
            transition: all var(--anim-speed) var(--anim-curve); transform: translateY(10px); 
        }
        .cart-area.active { opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0); }

        .settings-area { 
            padding-top: calc(70px + env(safe-area-inset-top)) !important; 
            display: flex; flex-direction: column; background: var(--bg); position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 160; opacity: 0; visibility: hidden; pointer-events: none; padding: 20px; transition: all var(--anim-speed) var(--anim-curve); backdrop-filter: blur(10px); 
        }
        .settings-area.active { opacity: 1; visibility: visible; pointer-events: auto; }
        
        .setting-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: transform 0.2s var(--anim-curve); }
        .setting-card:hover { border-color: var(--primary); background: var(--surface-hover); transform: scale(0.98); }
        .setting-label { font-weight: 600; font-size: 14px; }
        .setting-val { color: var(--text-muted); font-size: 13px; font-weight: 500; }

        /* FLOATING PILL BOTTOM NAV (MOBILE) */
        .bottom-nav { 
            display: flex; position: fixed; 
            bottom: 30px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 450px; height: 65px; 
            background: var(--glass-bg); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            justify-content: center; align-items: center; gap: 5px; 
            z-index: 280; border-radius: 35px; padding: 5px; 
        }
        .nav-item { 
            flex: 1; height: 100%; font-weight: 700; font-size: 10px; color: var(--text-muted); 
            background: transparent; border: none; letter-spacing: 0.5px; transition: background-color 0.3s, transform 0.3s; 
            border-radius: 30px; position: relative; cursor: pointer;
        }
        .nav-item:hover {
            background-color: var(--glass-bg);
        }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item:active { transform: scale(0.95); }
        
        /* LOYALTY FADE BLUE STYLING */
        .loyalty-pill { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); color: #0284c7; }

        .nav-badge { 
            position: absolute; top: 2px; right: 5px; background: #FF3B30; color: white; 
            font-size: 9px; font-weight: 800; padding: 2px 5px; border-radius: 10px; opacity: 0; transition: 0.2s; transform: scale(0); 
        }
        .nav-badge.show { opacity: 1; transform: scale(1); }

        .desktop-nav-group { display: none; flex-direction: column; }

        /* INVENTORY DESKTOP GRID CLASSES */
        .inv-container { display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; overflow-y: auto; flex:1; padding: 15px; padding-bottom:120px; }
        .dashboard-wrapper { width: 100%; display: flex; flex-direction: column; }
        .inv-left-col, .inv-right-col { display: flex; flex-direction: column; }

        /* DESKTOP STYLES */
        @media (min-width: 1024px) {
            body { padding-top: 0; }
            .app-header { height: 70px; padding: 0 20px; } 
            .main-stage { display: grid; grid-template-columns: 1fr 380px; gap: 30px; }
            .cart-area { 
                position: static; 
                height: calc(100vh - 120px); 
                top: auto; bottom: auto; 
                opacity: 1; visibility: visible; pointer-events: auto; transform: none; 
                border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
            }
            .settings-area { width: 400px; right: 0; left: auto; border-left: 1px solid var(--border); box-shadow: -10px 0 30px rgba(0,0,0,0.05); padding-top: 20px !important; }
            .menu-area { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            
            .bottom-nav { display: none !important; }
            .desktop-nav-group { display: flex !important; }
            
            #managerPage .app-header, #historyPage .app-header, #inventoryPage .app-header { height: 70px !important; padding: 0 20px !important; }

            /* Desktop Inventory Split Layout */
            .inv-container { 
                max-width: 1200px !important; 
                display: grid !important; 
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: auto 1fr;
                gap: 0 40px; 
                padding-bottom: 30px !important; 
                align-items: start;
            }
            .dashboard-wrapper { grid-column: 2; grid-row: 1; }
            .inv-right-col { grid-column: 2; grid-row: 2; }
            .inv-left-col { 
                grid-column: 1; grid-row: 1 / 3; 
                position: sticky; top: 0; 
                max-height: calc(100vh - 100px); 
                overflow-y: auto; padding-right: 10px; 
            }
        }

        .cart-header { padding: 20px; font-size: 12px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--border); background: var(--surface); border-radius: var(--radius) var(--radius) 0 0; }
        .cart-list { flex: 1; overflow-y: auto; padding: 0 20px; }
        .cart-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); animation: fadeScale 0.2s; }
        .item-name { font-size: 13px; font-weight: 600; color: var(--text); }
        .mini-select { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 10px; font-weight: 500; padding: 4px; color: var(--text); outline: none; margin-top: 4px; }
        .item-price { font-weight: 700; font-size: 13px; color: var(--primary); }
        .del-btn { color: var(--text-muted); background: none; border: none; font-size: 18px; cursor: pointer; transition: color 0.2s; }
        .del-btn:hover { color: #FF3B30; }
        
        .cart-footer { 
            order: -1; padding: 20px 25px; background: var(--surface); 
            border-bottom: 1px solid var(--border); border-top: none;
            border-radius: var(--radius) var(--radius) 0 0; flex-shrink: 0; z-index: 10;
        }
        @media (min-width: 1024px) {
            .cart-footer { order: 0; border-top: 1px solid var(--border); border-bottom: none; border-radius: 0 0 var(--radius) var(--radius); padding: 25px; }
        }
        
        .total-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 20px; }
        .total-label { font-size: 12px; color: var(--text-muted); font-weight: 600; letter-spacing: 1px; }
        .total-display { font-size: 26px; font-weight: 700; color: var(--primary); transition: color 0.3s; }
        .controls { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
        .btn { padding: 16px; border-radius: var(--radius); font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; border: 1px solid var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .btn-confirm { background: var(--primary); color: #fff; }
        .btn-confirm:active { transform: scale(0.95); }
        .btn-clear { background: transparent; color: #FF3B30; border: 1px solid #FF3B30; }
        .btn-clear:active { transform: scale(0.95); background: rgba(255, 59, 48, 0.1); }

        .toast-msg { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--primary); color: white; padding: 12px 24px; border-radius: 30px; font-weight: 600; font-size: 13px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 250; opacity: 0; visibility: hidden; transition: 0.3s cubic-bezier(0.2, 0, 0, 1); white-space: nowrap; max-width: 85vw; overflow: hidden; text-overflow: ellipsis; }
        .toast-msg.show { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; }

        .text-btn { background: transparent; border: none; font-size: 14px; font-weight: 700; color: var(--text); padding: 10px 15px; border-radius: 8px; cursor: pointer; letter-spacing: 0.5px; }
        .text-btn:active { background: var(--surface-hover); }

        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.4s; }
        #loginScreen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
        .login-logo { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--primary); margin-bottom: 20px; }
        .login-title { font-family: 'Quicksand', sans-serif; font-size: 24px; color: var(--primary); margin-bottom: 40px; }
        .user-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text); width: 260px; height: 60px; margin-bottom: 12px; border-radius: var(--radius); font-weight: 600; font-size: 14px; cursor: pointer; letter-spacing: 1px; transition: 0.2s; }
        .pin-display { display: flex; gap: 15px; margin-bottom: 30px; width: 200px; justify-content: center; height: 20px; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--border); transition: 0.2s; }
        .pin-dot.active { background: var(--primary); transform: scale(1.2); }
        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 280px; }
        .num-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text); font-size: 22px; font-weight: 600; height: 65px; border-radius: var(--radius); cursor: pointer; transition: 0.1s; display: flex; align-items: center; justify-content: center; }
        .num-btn:active { background: var(--border); transform: scale(0.95); }
        .num-btn.clear { color: #FF3B30; font-size: 16px; font-weight: 700; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .shake { animation: shake 0.3s ease-in-out; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); backdrop-filter: blur(5px); z-index: 300; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-box { background: var(--surface); width: 90%; max-width: 380px; padding: 30px; text-align: center; border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .modal-title { color: var(--primary); font-family: 'Quicksand', sans-serif; font-size: 20px; margin-bottom: 15px; }

        .receipt-paper { background: white; color: #000; padding: 20px; width: 100%; margin: 0 auto; font-family: 'Courier Prime', monospace; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .rp-header { margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        .rp-logo { width: 40px; height: 40px; border-radius: 50%; filter: grayscale(100%); margin-bottom: 5px; }
        .rp-title { font-weight: 700; font-size: 16px; margin-top: 5px; }
        .rp-items { text-align: left; font-size: 12px; margin-bottom: 15px; }
        .rp-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .rp-total { border-top: 1px dashed #000; padding-top: 10px; font-weight: 700; font-size: 14px; text-align: right; }
        .preview-scroll-container { max-height: 55vh; overflow-y: auto; background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; }

        /* ALL FULL SCREEN PAGES */
        #historyPage, #managerPage, #inventoryPage { z-index: 250; background: var(--bg); }
        
        .history-card, .manager-card { 
            background: var(--surface); border: 1px solid var(--border); 
            border-radius: 12px; padding: 15px; margin-bottom: 10px; 
            display: flex; flex-direction: column; gap: 8px;
        }
        
        #historyPage .app-header, #managerPage .app-header, #inventoryPage .app-header {
            height: calc(70px + env(safe-area-inset-top));
            padding: env(safe-area-inset-top) 20px 0 20px;
        }

        .hc-header { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: 700; color: var(--text); border-bottom: 1px dashed var(--border); padding-bottom: 8px; }
        .hc-total { text-align: right; font-weight: 700; font-size: 14px; color: var(--primary); padding-top: 5px; }

        /* UPGRADED DONUT CHART STYLES */
        .dashboard-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 25px 20px; margin-bottom: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.04); transition: opacity 0.3s ease; }
        .dash-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; font-weight: 600; }
        .dash-val { font-weight: 700; }
        .profit-val { font-size: 18px; text-align: right; margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 15px; font-weight: 800; }
        
        /* FIXED: REDUCED GAP FOR MOBILE SCREENS SO TEXT DOES NOT WRAP */
        .chart-container { display: flex; gap: 20px; align-items: center; margin-top: 25px; padding: 20px; background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border); }
        
        .pie-chart { 
            width: 120px; height: 120px; 
            border-radius: 50%; flex-shrink: 0; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.12); 
            position: relative; 
        }
        .pie-chart::after { 
            content: ''; position: absolute; 
            top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 70px; height: 70px; 
            background: var(--bg); 
            border-radius: 50%; 
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.08); 
            z-index: 1; 
        }
        .pie-center-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 2; font-size: 18px; font-weight: 800; color: var(--text); 
        }
        
        .chart-legend { flex: 1; display: flex; flex-direction: column; gap: 14px; }
        
        /* FIXED: FORCED WHITE-SPACE NOWRAP SO "(94%)" NEVER BREAKS TO A NEW LINE */
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; }
        
        .dot { width: 14px; height: 14px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .dot.sales { background: var(--primary); }
        .dot.expenses { background: #FF3B30; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block; color: var(--text-muted); }
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; outline: none; }
        .form-check { display: flex; align-items: center; gap: 10px; margin-top: 5px; }

        .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px dashed var(--border); border-radius: 8px; font-size: 12px; }

        #editorModal, #invEditorModal { z-index: 260; background: rgba(0,0,0,0.5); }
        .editor-form { width: 90%; max-width: 400px; background: var(--surface); padding: 25px; border-radius: var(--radius); max-height: 85vh; overflow-y: auto; }

        #testBanner { display: none; background: var(--primary); color: #fff; text-align: center; font-weight: 800; font-size: 10px; padding: 5px; position: fixed; top: 0; width: 100%; z-index: 10000; }
        body.testing .app-header { margin-top: 20px; }

        #receiptContainer { display: none; }
        @media print {
            body, .app-header, .main-stage, .bottom-nav, #modal, #historyPage, #managerPage, #editorModal, #inventoryPage, #invEditorModal { display: none !important; }
            #receiptContainer { display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .receipt-paper { box-shadow: none; border: none; width: 100%; max-width: 100%; margin: 0; }
        }
    </style>
</head>
<body class="testing" data-theme="light">

    <div id="toast" class="toast-msg">Item Added</div>

    <div id="loginScreen">
        <img src="https://raw.githubusercontent.com/Nanthe27/MyDayMatcha/a10b4d4f580a0e014e57221c0b136abf501a8d1f/Logo.png" class="login-logo">
        <h2 id="loginTitle" class="login-title">It's loading, wait abit</h2>
        <div id="userListGrid" style="display:flex; flex-direction:column;"></div>
        <div id="pinContainer" style="display:none; flex-direction:column; align-items:center;">
            <div id="pinDisplay" class="pin-display"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
            <div class="numpad-grid">
                <button class="num-btn" onclick="handleNumpad(1)">1</button><button class="num-btn" onclick="handleNumpad(2)">2</button><button class="num-btn" onclick="handleNumpad(3)">3</button>
                <button class="num-btn" onclick="handleNumpad(4)">4</button><button class="num-btn" onclick="handleNumpad(5)">5</button><button class="num-btn" onclick="handleNumpad(6)">6</button>
                <button class="num-btn" onclick="handleNumpad(7)">7</button><button class="num-btn" onclick="handleNumpad(8)">8</button><button class="num-btn" onclick="handleNumpad(9)">9</button>
                <button class="num-btn clear" onclick="cancelLogin()">BACK</button><button class="num-btn" onclick="handleNumpad(0)">0</button><button class="num-btn clear" onclick="handleNumpad('del')">⌫</button>
            </div>
        </div>
    </div>

    <header class="app-header">
        <div class="brand">
            <img src="https://raw.githubusercontent.com/Nanthe27/MyDayMatcha/a10b4d4f580a0e014e57221c0b136abf501a8d1f/Logo.png" class="app-logo">
            MY DAY MATCHA
        </div>
        <button id="hamburgerBtn" class="hamburger-btn" onclick="toggleSettings()">☰</button>
    </header>

    <div class="main-stage">
        <div class="menu-area" id="menuArea"></div>

        <div class="cart-area" id="cartPanel">
            <div class="cart-header">Current Order</div>
            <div class="cart-list" id="cartList"></div>
            <div class="cart-footer">
                <div class="total-row">
                    <span class="total-label" style="display:flex; align-items:center;">
                        TOTAL
                        <select id="globalDiscountSelect" class="mini-select" onchange="updateGlobalDiscount(this.value)" style="margin-left:10px; margin-top:0;">
                            <option value="0">No Disc</option>
                            <option value="10">10% Off</option>
                            <option value="15">15% Off</option>
                            <option value="20">20% Off</option>
                            <option value="30">30% Off</option>
                            <option value="50">50% Off</option>
                            <option value="100">Free</option>
                        </select>
                    </span>
                    <span class="total-display" id="totalDisplay">0 KHR</span>
                </div>
                <div class="controls"><button class="btn btn-clear" onclick="confirmClear()">Clear</button><button class="btn btn-confirm" onclick="confirmOrder()">Confirm</button></div>
            </div>
        </div>

        <div class="settings-area" id="settingsPanel">
            <h3 style="margin-bottom:20px; color:var(--text-muted); font-size:12px; letter-spacing:1px;">SETTINGS</h3>
            <div class="setting-card" onclick="toggleTheme()"><div class="setting-label">Theme Mode</div><div class="setting-val" id="themeDisplay">Light Mode</div></div>
            <div class="setting-card" onclick="openHistory()"><div class="setting-label">History</div><div class="setting-val">View ></div></div>
            <div class="setting-card" onclick="openManager()"><div class="setting-label">Manage Menu</div><div class="setting-val">></div></div>
            
            <a href="https://nanthe27.github.io/MyDayMatcha/staff/" class="setting-card loyalty-pill" style="text-decoration: none; border: none; justify-content: center; margin-top: 15px;">
                <div class="setting-label" style="font-size: 14px; font-weight: 800;">Customer Loyalty</div>
            </a>
            
            <div class="desktop-nav-group">
                <h3 style="margin-top:20px; margin-bottom:20px; color:var(--text-muted); font-size:12px; letter-spacing:1px;">APP NAVIGATION</h3>
                <div class="setting-card" onclick="switchTab('inventory')"><div class="setting-label">Stock Tracker</div><div class="setting-val">></div></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('menu')" id="btnMenu">MENU</button>
        <button class="nav-item" onclick="switchTab('cart')" id="btnCart">ORDER <span id="navBadge" class="nav-badge">0</span></button>
        <button class="nav-item" onclick="switchTab('inventory')" id="btnInventory">STOCK</button>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="mTitle" class="modal-title">Title</h3>
            <div id="mText" style="color:var(--text-muted); font-size:14px; margin-bottom:30px;">Text</div>
            <input id="mInput" type="text" placeholder="Type code here" style="display:none; width:100%; margin-bottom:15px; padding:10px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <button id="mCloseBtn" class="btn btn-clear" onclick="closeModal()">CANCEL</button>
                <button class="btn btn-confirm" id="mBtn">YES</button>
            </div>
        </div>
    </div>

    <div id="historyPage" class="modal-overlay" style="flex-direction:column; justify-content:start; background:var(--bg);">
        <div class="app-header" style="width:100%;">
            <button class="text-btn" style="font-size:28px; line-height:1; padding:0 15px;" onclick="document.getElementById('historyPage').classList.remove('open')">‹</button>
            <span id="historyTotalTitle" style="font-weight:700; color:var(--primary); font-size:18px;">0 KHR</span>
            <button class="text-btn" style="color:#FF3B30;" onclick="requestDeleteHistory()">DELETE ALL</button>
        </div>
        <div id="historyList" style="width: 100%; max-width: 600px; margin: 0 auto; overflow-y: auto; flex:1; padding: 10px; padding-bottom:100px;"></div>
    </div>

    <div id="managerPage" class="modal-overlay" style="flex-direction:column; justify-content:start; background:var(--bg);">
        <div class="app-header" style="width:100%;">
            <button class="text-btn" style="font-size:28px; line-height:1; padding:0 15px;" onclick="document.getElementById('managerPage').classList.remove('open')">‹</button>
            <span style="font-weight:700; color:var(--primary); font-size:16px;">MANAGE MENU</span>
            <button class="text-btn" style="color:var(--primary);" onclick="newItem()">+ ADD</button>
        </div>
        <div id="managerList" style="width: 100%; max-width: 600px; margin: 0 auto; overflow-y: auto; flex:1; padding: 10px; padding-bottom:100px;"></div>
    </div>

    <div id="inventoryPage" class="modal-overlay" style="flex-direction:column; justify-content:start; background:var(--bg);">
        <div class="app-header" style="width:100%;">
            <button class="text-btn" style="font-size:28px; line-height:1; padding:0 15px;" onclick="switchTab('menu')">‹</button>
            <span style="font-weight:700; color:var(--primary); font-size:16px;">STOCK TRACKER</span>
            <div style="width:40px;"></div>
        </div>
        
        <div class="inv-container">
            
            <div class="dashboard-wrapper">
                <div class="dashboard-card">
                    <div style="font-size: 11px; font-weight: 800; color: var(--text-muted); margin-bottom: 15px; letter-spacing: 1px; text-transform: uppercase;">This Month</div>
                    
                    <div id="invDashboard" style="transition: opacity 0.3s ease;">
                        <div class="dash-row"><span style="color:var(--text-muted)">Total Sales Income</span><span class="dash-val" id="dashSales" style="color:var(--primary); transition: color 0.3s ease;">+0 KHR</span></div>
                        <div class="dash-row"><span style="color:var(--text-muted)">Total Inventory Cost</span><span class="dash-val" id="dashCost" style="color:#FF3B30; transition: color 0.3s ease;">-0 KHR</span></div>
                        
                        <div class="profit-val" id="dashProfit" style="color:var(--primary); transition: color 0.3s ease;">Actual Profit: 0 KHR</div>
                        
                        <div class="chart-container">
                            <div class="pie-chart" id="dashPie" style="background: conic-gradient(var(--primary) 0% 50%, #FF3B30 50% 100%); transition: background 0.5s ease;">
                                <div class="pie-center-text" id="dashPieText">50%</div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item"><div class="dot sales"></div> Income (<span id="dashSalesPct">50</span>%)</div>
                                <div class="legend-item"><div class="dot expenses"></div> Expense (<span id="dashExpPct">50</span>%)</div>
                            </div>
                        </div>
                    </div>

                    <button class="text-btn" style="width:100%; margin-top:20px; font-size:12px; font-weight:800; color:var(--text-muted); text-align:center; border-top:1px solid var(--border); border-radius:0; padding-top:15px; padding-bottom:5px;" onclick="toggleAllTimeStats()">VIEW ALL TIME PROFIT ▾</button>
                    
                    <div id="allTimeStats" style="display:none; flex-direction:column; margin-top:10px; padding-top:15px; border-top:1px dashed var(--border);">
                        <div style="text-align:center; color:var(--text-muted); font-size:12px;" id="allTimeLoading">Loading All-Time Data...</div>
                        <div id="allTimeContent" style="display:none;">
                            <div class="dash-row"><span style="color:var(--text-muted)">All Time Income</span><span class="dash-val" id="atSales" style="color:var(--primary)">+0 KHR</span></div>
                            <div class="dash-row"><span style="color:var(--text-muted)">All Time Cost</span><span class="dash-val" id="atCost" style="color:#FF3B30">-0 KHR</span></div>
                            <div class="profit-val" id="atProfit" style="font-size:16px; border-top:none; margin-top:5px; padding-top:5px;">All Time Profit: 0 KHR</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="inv-left-col">
                <div class="cart-header" style="border-radius:var(--radius); margin-bottom: 10px; padding:15px; background:none;">ADD EXPENSE</div>
                <div style="background:var(--surface); padding:20px; border-radius:var(--radius); border:1px solid var(--border); margin-bottom: 25px;">
                    <div class="form-group"><label class="form-label">Ingredient Name</label><input id="invItem" class="form-input" placeholder="e.g., Matcha Powder"></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div class="form-group"><label class="form-label">Unit Size (e.g., 1L)</label><input id="invUnit" class="form-input" placeholder="e.g., 1 kg"></div>
                        <div class="form-group"><label class="form-label">Amount Bought</label><input id="invAmount" type="number" class="form-input" placeholder="e.g., 2"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Total Cost (KHR)</label><input id="invCost" type="number" class="form-input" placeholder="0"></div>
                    
                    <button class="btn btn-clear" style="width:100%; margin-top:10px; border-color:var(--primary); color:var(--primary);" onclick="addPendingInventory()">+ ADD TO LIST</button>
                    
                    <div id="pendingInvList" style="margin-top:15px; display:flex; flex-direction:column; gap:8px; max-height:250px; overflow-y:auto; padding-right:5px;"></div>
                    
                    <button id="btnSaveInv" class="btn btn-confirm" style="width:100%; margin-top:15px; display:none;" onclick="saveInventory()">SAVE ALL RECORDS</button>
                </div>
            </div>

            <div class="inv-right-col">
                <div class="cart-header" style="border-radius:var(--radius); margin-bottom: 10px; padding:15px; background:none;">RECENT PURCHASES</div>
                <div id="inventoryList"></div>
            </div>
        </div>
    </div>

    <div id="editorModal" class="modal-overlay">
        <div class="editor-form">
            <h3 style="margin-bottom:20px; text-align:center;">Edit Drink</h3>
            <div class="form-group"><label class="form-label">Category</label><input id="eCat" class="form-input" placeholder="e.g., Coffee"></div>
            <div class="form-group"><label class="form-label">ID (Unique)</label><input id="eId" class="form-input" placeholder="e.g., C01"></div>
            <div class="form-group"><label class="form-label">Name</label><input id="eName" class="form-input" placeholder="Drink Name"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group"><label class="form-label">Price (KHR)</label><input id="ePrice" type="number" class="form-input"></div>
                <div class="form-group"><label class="form-label">Cost (KHR)</label><input id="eCost" type="number" class="form-input"></div>
            </div>
            <div class="form-group"><label class="form-label">Has Milk Option?</label><div class="form-check"><input id="eMilk" type="checkbox" style="width:20px;height:20px;"> <span>Yes</span></div></div>
            <div class="form-group"><label class="form-label">Oat Milk Price (KHR)</label><input id="eOat" type="number" class="form-input" value="0"></div>
            <div class="form-group"><label class="form-label">Image URL</label><input id="eImg" class="form-input" placeholder="https://raw.github..."></div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                <button class="btn btn-clear" onclick="document.getElementById('editorModal').classList.remove('open')">CANCEL</button>
                <button class="btn btn-confirm" onclick="saveItem()">SAVE</button>
            </div>
            <button class="btn btn-clear" style="width:100%; margin-top:15px; border-color:#FF3B30; color:#FF3B30;" onclick="confirmDelete()">DELETE ITEM</button>
        </div>
    </div>

    <div id="invEditorModal" class="modal-overlay">
        <div class="editor-form">
            <h3 style="margin-bottom:20px; text-align:center;">Edit Record</h3>
            <input type="hidden" id="eiOldDate">
            <input type="hidden" id="eiOldTime">
            <input type="hidden" id="eiOldItem">
            
            <div class="form-group"><label class="form-label">Ingredient Name</label><input id="eiItem" class="form-input"></div>
            <div class="form-group"><label class="form-label">Quantity</label><input id="eiQty" class="form-input"></div>
            <div class="form-group"><label class="form-label">Cost (KHR)</label><input id="eiCost" type="number" class="form-input"></div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                <button class="btn btn-clear" onclick="document.getElementById('invEditorModal').classList.remove('open')">CANCEL</button>
                <button class="btn btn-confirm" onclick="saveEditedInventory()">SAVE</button>
            </div>
        </div>
    </div>

    <div id="receiptContainer"></div>

    <script>
        const IS_TEST_MODE = false; 
        const LIVE_URL = 'https://script.google.com/macros/s/AKfycbzImNht-d6MzUvqNyE7eClI1QocEHmhSmLNFRYwdz4Svih06GoFer1zXRlI-SJH4YCl/exec'; 
        const TEST_URL = 'https://script.google.com/macros/s/AKfycbxjC8wSAVa6bgsm0Jhio0RJX3pMm8TeT3gLZI69obq82GYT3vt_PqET7AMhSlm6znPuPQ/exec';
        const GOOGLE_SCRIPT_URL = IS_TEST_MODE ? TEST_URL : LIVE_URL;

        if (IS_TEST_MODE) {
            const banner = document.createElement('div');
            banner.id = 'testBanner'; banner.innerText = 'TEST MODE'; banner.style.display = 'block'; document.body.prepend(banner);
        }

        let MENU_DATA = [];
        let currentOrder = [], todayRecords = [], deviceName = "Unknown", tempSelectedUser = null;
        let currentPin = ""; 
        let dailyOrderCount = parseInt(localStorage.getItem('myday_counter_' + new Date().toDateString())) || 0;
        let historyData = {}; 
        let pendingInventory = [];
        let globalOrderDiscount = 0;

        document.addEventListener('keydown', (e) => {
            if(document.getElementById('loginScreen').classList.contains('hidden')) return;
            if(!tempSelectedUser) return;
            if(e.key >= '0' && e.key <= '9') handleNumpad(parseInt(e.key));
            if(e.key === 'Backspace') handleNumpad('del');
            if(e.key === 'Enter') checkPin();
        });

        window.onload = () => { fetchUsers(); fetchMenu(); showLogin(); };

        function fetchUsers() {
            const cachedUsers = localStorage.getItem('myday_users');
            if (cachedUsers) renderUserGrid(JSON.parse(cachedUsers));

            fetch(GOOGLE_SCRIPT_URL + '?action=get_users').then(res => res.json()).then(data => {
                localStorage.setItem('myday_users', JSON.stringify(data));
                renderUserGrid(data);
            });
        }

        function renderUserGrid(data) {
            const grid = document.getElementById('userListGrid'); grid.innerHTML = '';
            data.forEach(name => {
                const btn = document.createElement('button'); btn.className = 'user-btn'; btn.innerText = name;
                btn.onclick = () => selectUser(name); grid.appendChild(btn);
            });
        }

        function showLogin() { document.getElementById('loginScreen').classList.remove('hidden'); cancelLogin(); toggleSettings(false); }
        function selectUser(name) { tempSelectedUser = name; currentPin = ""; updatePinDisplay(); document.getElementById('userListGrid').style.display = 'none'; document.getElementById('pinContainer').style.display = 'flex'; document.getElementById('loginTitle').innerText = name; }
        
        function cancelLogin() { 
            tempSelectedUser = null; currentPin = ""; 
            document.getElementById('userListGrid').style.display = 'flex'; 
            document.getElementById('pinContainer').style.display = 'none'; 
            document.getElementById('loginTitle').innerText = "It's loading, wait abit"; 
        }
        
        function handleNumpad(val) {
            if (val === 'del') currentPin = String(currentPin).slice(0, -1);
            else if (String(currentPin).length < 4) currentPin += val;
            updatePinDisplay();
            if (String(currentPin).length === 4) setTimeout(checkPin, 200);
        }

        function updatePinDisplay() { const dots = document.querySelectorAll('.pin-dot'); dots.forEach((dot, idx) => { if(idx < currentPin.length) dot.classList.add('active'); else dot.classList.remove('active'); }); }
        
        function checkPin() {
            if(currentPin.length !== 4) return;
            
            document.getElementById('pinDisplay').style.opacity = '0.5';

            fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'login', user: tempSelectedUser, pin: currentPin }) 
            })
            .then(res => res.json()).then(data => {
                document.getElementById('pinDisplay').style.opacity = '1';
                if(data.status === 'success') { 
                    deviceName = tempSelectedUser; 
                    
                    const userDisplayElement = document.getElementById('currentUserDisplay');
                    if (userDisplayElement) { userDisplayElement.innerText = deviceName; }
                    
                    document.getElementById('loginScreen').classList.add('hidden'); 
                } else { 
                    alert("Login Failed: " + (data.message || "Incorrect PIN. Check your Google Sheet."));
                    const display = document.getElementById('pinDisplay'); display.classList.add('shake'); 
                    setTimeout(() => { display.classList.remove('shake'); currentPin = ""; updatePinDisplay(); }, 400); 
                }
            }).catch(err => {
                document.getElementById('pinDisplay').style.opacity = '1';
                alert("Connection Blocked! Please ensure your Google Script URL is correct and deployed as 'Anyone'. Error: " + err.message);
                const display = document.getElementById('pinDisplay'); display.classList.add('shake'); 
                setTimeout(() => { display.classList.remove('shake'); currentPin = ""; updatePinDisplay(); }, 400);
            });
        }

        function fetchMenu() {
            const cachedMenu = localStorage.getItem('myday_menu');
            if (cachedMenu) processMenuData(JSON.parse(cachedMenu));

            fetch(GOOGLE_SCRIPT_URL + '?action=get_menu').then(res => res.json()).then(data => {
                localStorage.setItem('myday_menu', JSON.stringify(data));
                processMenuData(data);
            });
        }

        function processMenuData(data) {
            if(data && data.length > 0) {
                let grouped = {}; data.forEach(item => { if(!grouped[item.category]) grouped[item.category] = []; grouped[item.category].push(item); });
                MENU_DATA = Object.keys(grouped).map(cat => ({ category: cat, items: grouped[cat] }));
            }
            renderMenu();
        }

        function renderMenu() {
            const container = document.getElementById('menuArea'); container.innerHTML = '';
            MENU_DATA.forEach(grp => {
                grp.items.forEach(item => {
                    const btn = document.createElement('div'); btn.className = 'drink-btn';
                    let imgUrl = item.image;
                    if(!imgUrl || imgUrl === "") imgUrl = 'https://img.pikbest.com/origin/10/37/43/56YpIkbEsTKmG.png!bw700';
                    btn.innerHTML = `<div class="drink-icon-box" style="background-image: url('${imgUrl}');"></div><div class="drink-info-box"><div class="drink-name">${item.name}</div></div>`;
                    btn.onclick = () => addToCart(item);
                    container.appendChild(btn);
                });
            });
        }

        function addToCart(item) {
            currentOrder.push({ uid: Date.now() + Math.random(), ...item, milkOption: item.hasMilk ? 'Milk' : null, sweetness: '100%', discount: 0 });
            renderCart();
            const toast = document.getElementById('toast');
            toast.innerText = item.name + " Added!";
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1500);
        }

        function updateGlobalDiscount(val) {
            globalOrderDiscount = Number(val);
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cartList'); list.innerHTML = ''; let total = 0;
            currentOrder.forEach(item => {
                let baseP = item.price + (item.milkOption === 'Oat' ? item.oatPrice : 0); 
                let p = baseP - (baseP * (item.discount || 0) / 100); 
                total += p;
                
                const div = document.createElement('div'); div.className = 'cart-item';
                div.innerHTML = `<div><div class="item-name">${item.name}</div>
                    ${item.hasMilk ? `
                        <select class="mini-select" onchange="updateItem('${item.uid}','milk',this.value)">
                            <option value="Milk" ${item.milkOption === 'Milk' ? 'selected' : ''}>Milk</option>
                            <option value="Oat" ${item.milkOption === 'Oat' ? 'selected' : ''}>Oat (+${item.oatPrice} KHR)</option>
                        </select>
                    ` : ''}
                    <select class="mini-select" onchange="updateItem('${item.uid}','sweet',this.value)">
                        <option ${item.sweetness === '100%' ? 'selected' : ''}>100%</option>
                        <option ${item.sweetness === '75%' ? 'selected' : ''}>75%</option>
                        <option ${item.sweetness === '50%' ? 'selected' : ''}>50%</option>
                        <option ${item.sweetness === '0%' ? 'selected' : ''}>0%</option>
                    </select>
                    <select class="mini-select" onchange="updateItem('${item.uid}','discount',this.value)">
                        <option value="0" ${item.discount == 0 ? 'selected' : ''}>No Disc</option>
                        <option value="10" ${item.discount == 10 ? 'selected' : ''}>10% Off</option>
                        <option value="20" ${item.discount == 20 ? 'selected' : ''}>20% Off</option>
                        <option value="30" ${item.discount == 30 ? 'selected' : ''}>30% Off</option>
                        <option value="50" ${item.discount == 50 ? 'selected' : ''}>50% Off</option>
                        <option value="100" ${item.discount == 100 ? 'selected' : ''}>Free</option>
                    </select>
                    </div>
                    <div style="text-align:right"><div class="item-price">${p.toLocaleString()} KHR</div><button class="del-btn" onclick="removeItem('${item.uid}')">×</button></div>`;
                list.appendChild(div);
            });
            
            let finalTotal = total - (total * globalOrderDiscount / 100);
            document.getElementById('totalDisplay').innerText = finalTotal.toLocaleString() + ' KHR';
            
            const badge = document.getElementById('navBadge'); badge.innerText = currentOrder.length;
            if(currentOrder.length > 0) badge.classList.add('show'); else badge.classList.remove('show');
        }

        function updateItem(uid, k, v) { 
            const i = currentOrder.find(x => x.uid == uid); 
            if (k === 'discount') {
                i.discount = Number(v);
            } else {
                i[k === 'milk' ? 'milkOption' : 'sweetness'] = v; 
            }
            renderCart(); 
        }
        function removeItem(uid) { currentOrder = currentOrder.filter(x => x.uid != uid); renderCart(); }
        
        function confirmClear() { 
            if(currentOrder.length > 0) openModal('CLEAR', 'Reset cart?', () => { 
                currentOrder = []; 
                globalOrderDiscount = 0;
                document.getElementById('globalDiscountSelect').value = '0';
                renderCart(); 
            }); 
        }
        
        function switchTab(t) {
            document.getElementById('historyPage').classList.remove('open');
            document.getElementById('managerPage').classList.remove('open');
            document.getElementById('editorModal').classList.remove('open');
            document.getElementById('invEditorModal').classList.remove('open');
            document.getElementById('modal').classList.remove('open');

            const invPanel = document.getElementById('inventoryPage');
            
            if (t === 'inventory') {
                invPanel.classList.add('open');
                fetchInventoryAndStats();
            } else {
                invPanel.classList.remove('open');
                document.getElementById('menuArea').style.display = t === 'menu' ? 'grid' : 'none';
                
                const panel = document.getElementById('cartPanel');
                if (t === 'cart') panel.classList.add('active'); else panel.classList.remove('active');
            }
            
            document.getElementById('btnMenu').classList.toggle('active', t === 'menu');
            document.getElementById('btnCart').classList.toggle('active', t === 'cart');
            document.getElementById('btnInventory').classList.toggle('active', t === 'inventory');
            
            toggleSettings(false);
        }

        function toggleSettings(forceState) {
            const panel = document.getElementById('settingsPanel');
            const btn = document.getElementById('hamburgerBtn');
            if (forceState !== undefined) {
                if(forceState) { panel.classList.add('active'); btn.classList.add('active'); }
                else { panel.classList.remove('active'); btn.classList.remove('active'); }
            } else {
                panel.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function getGroupedItems(items) {
            let groups = [];
            items.forEach(item => {
                let sig = item.name + '|' + item.sweetness + '|' + (item.milkOption || 'No') + '|' + (item.discount || 0);
                let existing = groups.find(g => g.sig === sig);
                if (existing) { existing.qty++; } 
                else { groups.push({ ...item, qty: 1, sig: sig }); }
            });
            return groups;
        }

        function confirmOrder() {
            if(currentOrder.length === 0) return;
            let total = 0; let html = '<div style="background:var(--bg); padding:10px; border-radius:8px;">';
            const grouped = getGroupedItems(currentOrder);
            grouped.forEach(i => {
                let baseP = i.price + (i.milkOption==='Oat'?i.oatPrice:0); 
                let itemP = baseP - (baseP * (i.discount || 0) / 100);
                let rowP = itemP * i.qty;
                total += rowP;
                let countStr = i.qty > 1 ? `<b style="color:var(--primary)">x${i.qty}</b> ` : '';
                let discStr = i.discount > 0 ? ` <span style="color:#FF3B30;font-size:10px;">(-${i.discount}%)</span>` : '';
                
                html += `<div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px; border-bottom:1px solid var(--border); padding-bottom:5px;">
                    <span>${countStr}${i.name} <span style="color:var(--text-muted);font-size:10px;">(${i.sweetness})</span>${discStr}</span>
                    <span>${rowP.toLocaleString()} KHR</span></div>`;
            });
            
            let finalTotal = total - (total * globalOrderDiscount / 100);
            if(globalOrderDiscount > 0) {
                html += `<div style="text-align:right; font-size:12px; color:#FF3B30; margin-top:5px;">Order Discount: -${globalOrderDiscount}%</div>`;
            }
            html += `</div><div style="text-align:right; font-weight:700; color:var(--primary); margin-top:10px; font-size:18px;">${finalTotal.toLocaleString()} KHR</div>`;
            
            openModal('CONFIRM', html, () => processOrder());
        }

        function processOrder() {
            const now = new Date(); dailyOrderCount++;
            localStorage.setItem('myday_counter_' + now.toDateString(), dailyOrderCount);
            const id = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(dailyOrderCount).padStart(3,'0')}`;
            const dateStr = now.toLocaleDateString('en-GB');
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const payload = currentOrder.map(i => {
                let baseP = i.price + (i.milkOption==='Oat'?i.oatPrice:0);
                let itemP = baseP - (baseP * (i.discount || 0) / 100);
                let finalP = itemP - (itemP * globalOrderDiscount / 100); 
                let discNameStr = i.discount > 0 ? ` -${i.discount}%` : '';
                let globalDiscStr = globalOrderDiscount > 0 ? ` (Order -${globalOrderDiscount}%)` : '';
                
                return { id, name: `${i.name} (${i.sweetness})${discNameStr}${globalDiscStr}`, price: finalP, cost: i.cost, qty: 1, profit: 0 };
            });
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ user: deviceName, items: payload }) });
            
            const orderForPrint = { id, date: dateStr, time: timeStr, items: getGroupedItems(currentOrder), globalDiscount: globalOrderDiscount };
            
            currentOrder = []; 
            globalOrderDiscount = 0; 
            document.getElementById('globalDiscountSelect').value = '0';
            renderCart(); 
            switchTab('menu');
            
            const html = generateReceiptHTML(orderForPrint);
            openModal('ORDER SAVED', `<div class="preview-scroll-container"><div class="receipt-paper">${html}</div></div>`, () => {
                document.getElementById('receiptContainer').innerHTML = html; 
                window.print();
            }, 'PRINT');
            return false;
        }

        function generateReceiptHTML(d) {
            let total = 0; let rows = '';
            d.items.forEach(i => {
                let baseP = i.price + (i.milkOption==='Oat'?i.oatPrice:0); 
                let itemP = baseP - (baseP * (i.discount || 0) / 100);
                let rowP = itemP * i.qty;
                total += rowP;
                let qtyStr = i.qty > 1 ? `x${i.qty} ` : '';
                let discStr = i.discount > 0 ? ` (-${i.discount}%)` : '';
                
                rows += `<div class="rp-row">
                    <div>${qtyStr}${i.name.toUpperCase()}<br><small>${i.sweetness}${i.milkOption?', '+i.milkOption:''}${discStr}</small></div>
                    <div class="rp-price">${rowP.toLocaleString()} KHR</div>
                </div>`;
            });
            
            let finalTotal = total - (total * (d.globalDiscount || 0) / 100);
            let discHTML = d.globalDiscount > 0 ? `<div class="rp-row" style="color:#666; border-top:1px dashed #ccc; padding-top:5px; margin-top:5px;"><div>ORDER DISCOUNT</div><div>-${d.globalDiscount}%</div></div>` : '';
            
            return `<div class="rp-header"><img src="https://raw.githubusercontent.com/Nanthe27/MyDayMatcha/a10b4d4f580a0e014e57221c0b136abf501a8d1f/Logo.png" class="rp-logo"><div class="rp-title">My Day Matcha</div></div>
                <div style="font-size:9px;margin-bottom:15px;">${d.date} ${d.time} | #${d.id}</div><div class="rp-items">${rows}</div>
                ${discHTML}
                <div class="rp-total">TOTAL: ${finalTotal.toLocaleString()} KHR</div>
                <div style="margin-top:20px; font-size:10px; font-weight:600; line-height:1.6;">
                    Order online via Telegram @mydaymatcha<br>
                    Truly appreciate your support
                </div>`;
        }

        function openModal(t, c, a, cl = 'CANCEL') {
            document.getElementById('mTitle').innerHTML = t; 
            document.getElementById('mText').innerHTML = c;
            const input = document.getElementById('mInput');
            input.style.display = 'none';
            input.value = '';
            document.getElementById('mCloseBtn').innerText = cl === 'PRINT' ? 'CLOSE' : 'CANCEL';
            const btn = document.getElementById('mBtn'); 
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.innerText = cl === 'PRINT' ? 'PRINT' : 'YES';
            newBtn.onclick = () => { 
                if(a) { if (a() !== false) closeModal(); } else { closeModal(); }
            };
            document.getElementById('modal').classList.add('open');
        }

        function requestDeleteHistory() {
            document.getElementById('mTitle').innerText = "DELETE ALL?";
            document.getElementById('mText').innerText = "Type YESDELETEALL to confirm:";
            const input = document.getElementById('mInput');
            input.style.display = 'block';
            input.focus();
            const btn = document.getElementById('mBtn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.innerText = "CONFIRM";
            newBtn.onclick = () => {
                if (input.value === "YESDELETEALL") {
                    closeModal();
                    fetch(GOOGLE_SCRIPT_URL, {method:'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body:JSON.stringify({action:'clear_all'})}).then(()=>openHistory());
                } else {
                    input.style.borderColor = "red";
                    input.classList.add('shake');
                    setTimeout(()=>input.classList.remove('shake'), 400);
                }
            };
            document.getElementById('modal').classList.add('open');
        }

        function closeModal() { document.getElementById('modal').classList.remove('open'); }
        function toggleTheme() { const b = document.body; const isDark = b.getAttribute('data-theme') === 'dark'; b.setAttribute('data-theme', isDark ? 'light' : 'dark'); document.getElementById('themeDisplay').innerText = isDark ? 'Light Mode' : 'Dark Mode'; }
        
        function openHistory() { 
            toggleSettings(false); 
            const list = document.getElementById('historyList');
            list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted)">Loading...</div>';
            document.getElementById('historyPage').classList.add('open'); 
            document.getElementById('historyTotalTitle').innerText = '0 KHR';
            fetch(GOOGLE_SCRIPT_URL + '?action=get_history').then(r=>r.json()).then(data => {
                list.innerHTML = '';
                if(data.length === 0) { list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted)">No sales this month</div>'; return; }
                historyData = {}; 
                let grandTotal = 0;
                data.forEach(item => {
                    grandTotal += item.price;
                    let rowId = item.id ? item.id : (item.date + '-' + item.time);
                    if(!historyData[rowId]) {
                        historyData[rowId] = { id: rowId, time: item.time, date: item.date, total: 0, items: [] };
                    }
                    historyData[rowId].total += item.price;
                    let existingItem = historyData[rowId].items.find(i => i.name === item.name);
                    if(existingItem) { existingItem.qty++; } else { historyData[rowId].items.push({ name: item.name, price: item.price, qty: 1, sweetness: '', milkOption: '' }); }
                });
                document.getElementById('historyTotalTitle').innerText = grandTotal.toLocaleString() + ' KHR';
                
                Object.keys(historyData).sort((a, b) => b.localeCompare(a)).forEach(id => {
                    const order = historyData[id];
                    const div = document.createElement('div');
                    div.className = 'history-card';
                    let itemsDisplay = order.items.map(i => (i.qty > 1 ? `x${i.qty} ` : '') + i.name).join(', ');
                    div.innerHTML = `
                        <div class="hc-header">
                            <span>#${id} | ${order.date} ${order.time}</span>
                            <button class="text-btn" style="padding:4px 8px; font-size:10px; border:1px solid var(--border);" onclick="printHistory('${id}')">PRINT</button>
                        </div>
                        <div style="font-size:13px;">${itemsDisplay}</div>
                        <div class="hc-total">${order.total.toLocaleString()} KHR</div>
                    `;
                    list.appendChild(div);
                });
            }).catch(e => { list.innerHTML = '<div style="padding:20px;text-align:center;color:red">Error loading history</div>'; });
        }

        function printHistory(id) {
            const order = historyData[id];
            if(!order) return;
            const html = generateReceiptHTML(order);
            openModal('PRINT RECORD', `<div class="preview-scroll-container"><div class="receipt-paper">${html}</div></div>`, () => {
                document.getElementById('receiptContainer').innerHTML = html; 
                window.print();
            }, 'PRINT');
        }

        function openManager() {
            toggleSettings(false);
            const list = document.getElementById('managerList');
            list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted)">Loading Menu...</div>';
            document.getElementById('managerPage').classList.add('open');
            
            fetch(GOOGLE_SCRIPT_URL + '?action=get_menu').then(res => res.json()).then(data => {
                if(data && data.length > 0) { renderManagerList(data); } 
                else { list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted)">Menu is empty</div>'; }
            }).catch(e => { list.innerHTML = '<div style="padding:20px;text-align:center;color:red">Connection Error</div>'; });
        }

        function renderManagerList(items) {
            const list = document.getElementById('managerList');
            list.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'manager-card';
                const itemStr = encodeURIComponent(JSON.stringify(item));
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700;">${item.name}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${item.category} | ${item.price.toLocaleString()} KHR</div>
                        </div>
                        <button class="text-btn" style="border:1px solid var(--border);" onclick="editItem('${itemStr}')">EDIT</button>
                    </div>`;
                list.appendChild(div);
            });
        }

        function newItem() { openEditor({ category:'', id:'', name:'', price:0, cost:0, hasMilk:false, oatPrice:0, image:'' }); }

        function editItem(itemStr) { const item = JSON.parse(decodeURIComponent(itemStr)); openEditor(item); }

        function openEditor(item) {
            document.getElementById('eCat').value = item.category;
            document.getElementById('eId').value = item.id;
            document.getElementById('eName').value = item.name;
            document.getElementById('ePrice').value = item.price;
            document.getElementById('eCost').value = item.cost;
            document.getElementById('eMilk').checked = item.hasMilk;
            document.getElementById('eOat').value = item.oatPrice;
            document.getElementById('eImg').value = item.image;
            document.getElementById('editorModal').classList.add('open');
        }

        function saveItem() {
            const item = {
                category: document.getElementById('eCat').value, id: document.getElementById('eId').value, name: document.getElementById('eName').value,
                price: Number(document.getElementById('ePrice').value), cost: Number(document.getElementById('eCost').value),
                hasMilk: document.getElementById('eMilk').checked, oatPrice: Number(document.getElementById('eOat').value), image: document.getElementById('eImg').value
            };
            if(!item.id || !item.name) { openModal('ERROR', 'ID and Name are required', null, 'CLOSE'); return; }
            document.getElementById('editorModal').classList.remove('open');
            document.getElementById('managerList').innerHTML = '<div style="padding:20px;text-align:center;">Saving...</div>';
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'save_item', ...item }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') { openManager(); fetchMenu(); } 
                else { openModal('ERROR', 'Error saving item: ' + (data.message || "Unknown error"), null, 'CLOSE'); openManager(); }
            }).catch(err => { openModal('ERROR', 'Connection Error.', null, 'CLOSE'); openManager(); });
        }

        function confirmDelete() { openModal('DELETE?', 'Are you sure you want to delete this item permanently?', () => deleteItem()); }

        function deleteItem() {
            const id = document.getElementById('eId').value;
            if(!id) return;
            document.getElementById('editorModal').classList.remove('open');
            document.getElementById('managerList').innerHTML = '<div style="padding:20px;text-align:center;">Deleting...</div>';

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'delete_item', id: id }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') { openManager(); fetchMenu(); } 
                else { openModal('ERROR', 'Error deleting item', null, 'CLOSE'); openManager(); }
            }).catch(err => { openModal('ERROR', 'Connection Error.', null, 'CLOSE'); openManager(); });
        }

        function addPendingInventory() {
            const item = document.getElementById('invItem').value;
            const unit = document.getElementById('invUnit').value;
            const amt = document.getElementById('invAmount').value;
            const cost = document.getElementById('invCost').value;

            if(!item || !unit || !amt || !cost) { openModal('ERROR', 'All fields are required', null, 'CLOSE'); return; }

            pendingInventory.push({ item: item, qty: amt + ' x ' + unit, cost: Number(cost) });
            
            document.getElementById('invItem').value = '';
            document.getElementById('invUnit').value = '';
            document.getElementById('invAmount').value = '';
            document.getElementById('invCost').value = '';
            renderPendingInv();
        }

        function removePendingInv(index) {
            pendingInventory.splice(index, 1);
            renderPendingInv();
        }

        function renderPendingInv() {
            const list = document.getElementById('pendingInvList');
            const btn = document.getElementById('btnSaveInv');
            list.innerHTML = '';
            if(pendingInventory.length > 0) {
                pendingInventory.forEach((p, i) => {
                    list.innerHTML += `<div class="pending-item">
                        <div><b>${p.item}</b> (${p.qty})</div>
                        <div><span style="color:#FF3B30; font-weight:bold;">${p.cost.toLocaleString()} KHR</span> <button class="text-btn" style="margin-left:10px; color:var(--text-muted); font-size:16px; padding:0 5px;" onclick="removePendingInv(${i})">×</button></div>
                    </div>`;
                });
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }

        function saveInventory() {
            if(pendingInventory.length === 0) return;
            document.getElementById('inventoryList').innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Saving Records...</div>';
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'save_inventory', user: deviceName, items: pendingInventory })
            }).then(res => res.json()).then(data => {
                pendingInventory = [];
                renderPendingInv();
                fetchInventoryAndStats();
            }).catch(e => {
                openModal('ERROR', 'Failed to save inventory.', null, 'CLOSE');
                fetchInventoryAndStats();
            });
        }

        function fetchInventoryAndStats() {
            const list = document.getElementById('inventoryList');
            const dash = document.getElementById('invDashboard');
            
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Loading Records...</div>';
            dash.style.opacity = '0.5';

            Promise.all([
                fetch(GOOGLE_SCRIPT_URL + '?action=get_inventory').then(r=>r.json()),
                fetch(GOOGLE_SCRIPT_URL + '?action=get_history').then(r=>r.json())
            ]).then(([invData, histData]) => {
                
                list.innerHTML = '';
                let totalInvCost = 0;
                
                if(invData.length === 0 || !invData.length) { 
                    list.innerHTML = '<div style="text-align:center; color:var(--text-muted);">No records found this month.</div>'; 
                } else {
                    invData.forEach(log => {
                        totalInvCost += Number(log.cost);
                        const div = document.createElement('div');
                        div.className = 'history-card';
                        const logStr = encodeURIComponent(JSON.stringify(log));
                        div.innerHTML = `
                            <div class="hc-header">
                                <span>${log.date} ${log.time}</span>
                                <div>
                                    <span style="font-weight:500; margin-right: 5px;">${log.user}</span>
                                    <button class="text-btn" style="padding:2px 6px; font-size:10px; border:1px solid var(--border);" onclick="openInvEditor('${logStr}')">EDIT</button>
                                    <button class="text-btn" style="padding:2px 6px; font-size:12px; border:1px solid #FF3B30; color:#FF3B30; margin-left: 3px;" onclick="confirmDeleteInv('${logStr}')">×</button>
                                </div>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:8px;">
                                <div style="font-size:13px;"><b>${log.item}</b> <span style="color:var(--text-muted);">(${log.qty})</span></div>
                                <div style="color:#FF3B30; font-weight:700; font-size:14px;">-${Number(log.cost).toLocaleString()} KHR</div>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }

                let totalSales = 0;
                if(histData.length > 0) {
                    histData.forEach(item => { totalSales += Number(item.price); });
                }

                let realProfit = totalSales - totalInvCost;
                let totalCombined = totalSales + totalInvCost;
                
                let salesPct = totalCombined > 0 ? Math.round((totalSales / totalCombined) * 100) : 50;
                let expPct = totalCombined > 0 ? Math.round((totalInvCost / totalCombined) * 100) : 50;
                
                let profitColor = realProfit >= 0 ? "var(--primary)" : "#FF3B30";

                document.getElementById('dashSales').innerText = '+' + totalSales.toLocaleString() + ' KHR';
                document.getElementById('dashCost').innerText = '-' + totalInvCost.toLocaleString() + ' KHR';
                
                const dProfit = document.getElementById('dashProfit');
                dProfit.innerText = 'Actual Profit: ' + realProfit.toLocaleString() + ' KHR';
                dProfit.style.color = profitColor;
                
                document.getElementById('dashPie').style.background = `conic-gradient(var(--primary) 0% ${salesPct}%, #FF3B30 ${salesPct}% 100%)`;
                document.getElementById('dashPieText').innerText = salesPct + '%';
                
                document.getElementById('dashSalesPct').innerText = salesPct;
                document.getElementById('dashExpPct').innerText = expPct;

                dash.style.opacity = '1';

            }).catch(e => { 
                list.innerHTML = '<div style="text-align:center; color:red;">Connection Error</div>'; 
                dash.style.opacity = '1'; 
            });
        }

        function toggleAllTimeStats() {
            const panel = document.getElementById('allTimeStats');
            const content = document.getElementById('allTimeContent');
            const loading = document.getElementById('allTimeLoading');

            if(panel.style.display === 'none') {
                panel.style.display = 'flex';
                loading.style.display = 'block';
                content.style.display = 'none';

                fetch(GOOGLE_SCRIPT_URL + '?action=get_all_time_stats')
                .then(r => r.json())
                .then(data => {
                    let sales = data.sales || 0;
                    let cost = data.cost || 0;
                    let profit = sales - cost;

                    document.getElementById('atSales').innerText = '+' + sales.toLocaleString() + ' KHR';
                    document.getElementById('atCost').innerText = '-' + cost.toLocaleString() + ' KHR';
                    
                    let pEl = document.getElementById('atProfit');
                    pEl.innerText = 'All Time Profit: ' + profit.toLocaleString() + ' KHR';
                    pEl.style.color = profit >= 0 ? "var(--primary)" : "#FF3B30";

                    loading.style.display = 'none';
                    content.style.display = 'block';
                }).catch(e => {
                    loading.innerText = 'Error loading connection.';
                });
            } else {
                panel.style.display = 'none';
            }
        }

        function openInvEditor(logStr) {
            const log = JSON.parse(decodeURIComponent(logStr));
            document.getElementById('eiOldDate').value = log.date;
            document.getElementById('eiOldTime').value = log.time;
            document.getElementById('eiOldItem').value = log.item;
            
            document.getElementById('eiItem').value = log.item;
            document.getElementById('eiQty').value = log.qty;
            document.getElementById('eiCost').value = log.cost;
            
            document.getElementById('invEditorModal').classList.add('open');
        }

        function saveEditedInventory() {
            const oldDate = document.getElementById('eiOldDate').value;
            const oldTime = document.getElementById('eiOldTime').value;
            const oldItem = document.getElementById('eiOldItem').value;
            
            const newItem = document.getElementById('eiItem').value;
            const newQty = document.getElementById('eiQty').value;
            const newCost = document.getElementById('eiCost').value;
            
            if(!newItem || !newCost) { openModal('ERROR', 'Item and Cost are required', null, 'CLOSE'); return; }
            
            document.getElementById('invEditorModal').classList.remove('open');
            document.getElementById('inventoryList').innerHTML = '<div style="text-align:center; padding:20px;">Updating...</div>';
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ 
                    action: 'edit_inventory', 
                    old_date: oldDate, old_time: oldTime, old_item: oldItem,
                    new_item: newItem, new_qty: newQty, new_cost: Number(newCost)
                })
            }).then(r => r.json()).then(data => { fetchInventoryAndStats();
            }).catch(e => { openModal('ERROR', 'Failed to update record.', null, 'CLOSE'); fetchInventoryAndStats(); });
        }

        function confirmDeleteInv(logStr) {
            openModal('DELETE?', 'Delete this inventory record permanently?', () => {
                const log = JSON.parse(decodeURIComponent(logStr));
                document.getElementById('inventoryList').innerHTML = '<div style="text-align:center; padding:20px;">Deleting...</div>';
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'delete_inventory', date: log.date, time: log.time, item: log.item })
                }).then(r => r.json()).then(data => { fetchInventoryAndStats();
                }).catch(e => { openModal('ERROR', 'Failed to delete record.', null, 'CLOSE'); fetchInventoryAndStats(); });
            });
        }
    </script>
</body>
</html>
